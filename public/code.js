"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function __awaiter(e,t,i,o){return new(i||(i=Promise))((function(n,a){function s(e){try{m(o.next(e))}catch(e){a(e)}}function r(e){try{m(o.throw(e))}catch(e){a(e)}}function m(e){e.done?n(e.value):new i((function(t){t(e.value)})).then(s,r)}m((o=o.apply(e,t||[])).next())}))}function compare(e,t){return e.name<t.name?-1:e.name>t.name?1:0}function insertComponentById(e){const t=figma.getNodeById(e).createInstance(),i=figma.currentPage.children;figma.viewport.center.x,figma.viewport.center.y;figma.currentPage.selection=[t],t.x=figma.viewport.center.x-t.width/2,t.y=figma.viewport.center.y-t.height/2,figma.ui.postMessage({notify:"hide"});for(let e=0;e<i.length;e++)if("FRAME"===i[e].type){const o=i[e];if(t.x>o.x&&t.x<o.x+o.width&&t.y>o.y&&t.y<o.y+o.height)return o.appendChild(t),t.x=figma.viewport.center.x-o.x-t.width/2,void(t.y=figma.viewport.center.y-o.y-t.height/2)}}function resize(e){e.auto&&(e.height=e.height>figma.viewport.bounds.height*figma.viewport.bounds.height?figma.viewport.bounds.height*figma.viewport.bounds.height:e.height),figma.ui.resize(e.width,e.height)}figma.showUI(__html__,{width:300,height:100}),figma.ui.postMessage({loadState:"INIT"});const insertTeamComponent=(e,t)=>__awaiter(void 0,void 0,void 0,(function*(){figma.ui.postMessage({notify:"show"});try{insertComponentById((yield figma.importComponentByKeyAsync(e)).id)}catch(e){figma.notify("Unable to import component. Make sure this team library is enabled in Assets > Team Library."),figma.ui.postMessage({notify:"hide"})}})),Libs={storageKey:"PLUGIN_ComponentsFlyoutMenu",libs:{},components:[],isTeamLibrary:!1,getLocalComponents(){this.components=[];for(let e=0;e<figma.root.children.length;e++){const t=figma.root.children[e].findAll(e=>"COMPONENT"===e.type),i=figma.root.name;for(let e=0;e<t.length;e++){const o=t[e];let n={};if("FRAME"===o.parent.type){let e=o.parent.name;n.name=e+"/"+o.name}else n.name=o.name;n.id=o.id,n.source=i,""!==o.key&&(n.key=o.key,this.isTeamLibrary=!0),this.components.push(n)}this.components.sort(compare)}return this.isTeamLibrary&&Libs.checkLibForUpdate(this.components),this.components},buildLocalComponents(){this.getLocalComponents(),figma.ui.postMessage({components:this.components})},loadStoredTeamLibraries(){return __awaiter(this,void 0,void 0,(function*(){const e=yield figma.clientStorage.getAsync(this.storageKey);figma.ui.postMessage({libs:e})}))},addLib(e){return __awaiter(this,void 0,void 0,(function*(){yield this.fetchLibraryStore(),this.libs[e]=this.components,yield figma.clientStorage.setAsync(this.storageKey,this.libs)}))},storeTeamLibrary(e){return __awaiter(this,void 0,void 0,(function*(){!0===this.isTeamLibrary?this.addLib(e):figma.notify("This is not a team library.")}))},initStorage(){return __awaiter(this,void 0,void 0,(function*(){void 0===(yield figma.clientStorage.getAsync(this.storageKey))&&(yield figma.clientStorage.setAsync(this.storageKey,{}))}))},fetchLibraryStore(){return __awaiter(this,void 0,void 0,(function*(){const e=yield figma.clientStorage.getAsync(this.storageKey);this.libs=e}))},checkLibs(){return __awaiter(this,void 0,void 0,(function*(){return yield figma.clientStorage.getAsync(this.storageKey)}))},checkLibForUpdate(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield figma.clientStorage.getAsync(this.storageKey);void 0===t[figma.root.name]&&figma.ui.postMessage({team:{type:"add",message:`Add Team Library "${figma.root.name}"`,count:`${e.length}`}}),t[figma.root.name].length!==e.length&&figma.ui.postMessage({team:{type:"update",message:`Update Team Library "${figma.root.name}"`,count:`${t[figma.root.name].length-e.length}`}})}))},removeLib(e){return __awaiter(this,void 0,void 0,(function*(){yield this.fetchLibraryStore(),delete this.libs[e],yield figma.clientStorage.setAsync(this.storageKey,this.libs)}))}};figma.ui.onmessage=e=>{var t;"load"===e.type&&(Libs.initStorage(),Libs.buildLocalComponents(),Libs.loadStoredTeamLibraries(),figma.ui.postMessage({loadState:"READY"})),"create-component-team"===e.type&&(void 0===e.component.key?insertComponentById(e.component.id):(t=e.component.key,e.component.id,__awaiter(void 0,void 0,void 0,(function*(){figma.ui.postMessage({notify:"show"});try{insertComponentById((yield figma.importComponentByKeyAsync(t)).id)}catch(e){figma.notify("Unable to import component. Make sure this team library is enabled in Assets > Team Library."),figma.ui.postMessage({notify:"hide"})}})))),"create-component-local"===e.type&&insertComponentById(e.component.id),"add"===e.type&&Libs.storeTeamLibrary(figma.root.name),"check"===e.type&&Libs.checkLibs(),"remove"===e.type&&Libs.removeLib(e.key),"resize"===e.type&&resize(e.size),"refresh"===e.type&&(figma.showUI(__html__,{width:300,height:100}),Libs.initStorage(),Libs.buildLocalComponents(),Libs.loadStoredTeamLibraries(),figma.ui.postMessage({loadState:"READY"}))};
